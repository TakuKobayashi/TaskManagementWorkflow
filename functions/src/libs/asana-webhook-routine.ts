import { AsanaWebhookPayload } from './interfaces/asana-webhook-payload';
const Asana = require('asana');

export class AsanaWebhookRoutine {
  private payload: AsanaWebhookPayload;

  constructor(asanaPayload: AsanaWebhookPayload) {
    this.payload = asanaPayload;
  }

  async execute(): Promise<void> {
    /*
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:24.361Z","action":"added","resource":{"gid":"1150953513460593","resource_type":"section"},"parent":{"gid":"1130115299148572","resource_type":"project"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:24.367Z","action":"changed","resource":{"gid":"1150953513460593","resource_type":"section"},"parent":null}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:55.936Z","action":"changed","parent":null,"resource":{"gid":"1130115299148572","resource_type":"project"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:55.898Z","action":"added","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":{"gid":"1130115299148572","resource_type":"project"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:55.941Z","action":"added","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":{"gid":"1145697202219739","resource_type":"section"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:00.253Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:54:55.942Z","action":"added","resource":{"gid":"1150953761397788","resource_type":"story","resource_subtype":"added_to_project"},"parent":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:03.727Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:21.967Z","action":"added","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":{"gid":"1130092645665357","resource_type":"project"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:22.111Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:22.114Z","action":"added","resource":{"gid":"1150953761397791","resource_type":"story","resource_subtype":"assigned"},"parent":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:43.472Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:55:43.479Z","action":"added","resource":{"gid":"1150953761397792","resource_type":"story","resource_subtype":"due_date_changed"},"parent":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:57:59.909Z","action":"added","resource":{"gid":"1150953761196867","resource_type":"attachment"},"parent":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:57:59.942Z","action":"added","resource":{"gid":"1150953761397794","resource_type":"story","resource_subtype":"attachment_added"},"parent":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:58:47.941Z","action":"deleted","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:58:47.954Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:58:59.052Z","action":"undeleted","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:58:59.078Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:59:15.993Z","action":"deleted","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T11:59:16.003Z","action":"changed","resource":{"gid":"1150953513460594","resource_type":"task","resource_subtype":"default_task"},"parent":null}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:00:03.137Z","action":"added","resource":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"},"parent":{"gid":"1130115299148572","resource_type":"project"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:00:03.180Z","action":"added","resource":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"},"parent":{"gid":"1145697202219739","resource_type":"section"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:00:08.595Z","action":"changed","resource":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:00:03.171Z","action":"changed","resource":{"gid":"1130115299148572","resource_type":"project"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:00:03.182Z","action":"added","resource":{"gid":"1150953761397800","resource_type":"story","resource_subtype":"added_to_project"},"parent":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:06:21.579Z","action":"added","resource":{"gid":"1150953761196869","resource_type":"attachment"},"parent":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"}},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:06:21.624Z","action":"added","resource":{"gid":"1150953921661636","resource_type":"story","resource_subtype":"attachment_added"},"parent":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"}}]}
{"events":[{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:06:37.656Z","action":"changed","resource":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"},"parent":null},{"user":{"gid":"1130090535992897","resource_type":"user"},"created_at":"2019-11-23T12:06:37.659Z","action":"added","resource":{"gid":"1150953921661637","resource_type":"story","resource_subtype":"marked_complete"},"parent":{"gid":"1150953513460596","resource_type":"task","resource_subtype":"default_task"}}]}
*/
    for (const event of this.payload.events) {
      console.log(event);
    }
  }

  async getAttachments(taskId: string) {
    const client = Asana.Client.create();
    const attachments = await client.attachments.findByTask(taskId, { opt_fields: ['download_url', 'name', 'view_url', 'created_at'] });
    return attachments;
  }
}
